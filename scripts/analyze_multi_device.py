#!/usr/bin/env python3
"""å…¨é¢æ£€æŸ¥å¤šè®¾å¤‡å…¼å®¹æ€§é—®é¢˜"""

import sys
import os

# Add the project root to Python path
sys.path.insert(0, '/mnt/data/TOOL/Open-AutoGLM')

def analyze_multi_device_compatibility():
    """åˆ†æå¤šè®¾å¤‡å…¼å®¹æ€§é—®é¢˜"""
    print("ğŸ” å¤šè®¾å¤‡å…¼å®¹æ€§å…¨é¢æ£€æŸ¥")
    print("=" * 60)
    
    issues = []
    
    with open('/mnt/data/TOOL/Open-AutoGLM/gui_app/app.py', 'r', encoding='utf-8') as f:
        content = f.read()
    
    # 1. é¢„è§ˆåŠŸèƒ½é—®é¢˜
    print("\nğŸ“º 1. å®æ—¶é¢„è§ˆåŠŸèƒ½")
    print("-" * 30)
    
    # æ£€æŸ¥é¢„è§ˆæ˜¯å¦ä½¿ç”¨è®¾å¤‡åˆ—è¡¨é€‰æ‹©
    if 'device_list.itemClicked' not in content and 'device_list.currentItemChanged' not in content:
        issues.append({
            "åŠŸèƒ½": "å®æ—¶é¢„è§ˆ",
            "é—®é¢˜": "é¢„è§ˆåŠŸèƒ½æœªå…³è”è®¾å¤‡åˆ—è¡¨é€‰æ‹©",
            "å½±å“": "å¤šè®¾å¤‡æ—¶æ— æ³•é¢„è§ˆæŒ‡å®šè®¾å¤‡",
            "ä¸¥é‡ç¨‹åº¦": "é«˜"
        })
        print("   âŒ é¢„è§ˆåŠŸèƒ½æœªå…³è”è®¾å¤‡åˆ—è¡¨é€‰æ‹©")
    else:
        print("   âœ… é¢„è§ˆåŠŸèƒ½å·²å…³è”è®¾å¤‡åˆ—è¡¨")
    
    # æ£€æŸ¥é¢„è§ˆæ˜¯å¦åªä½¿ç”¨device_id_input
    if 'device_id = self.device_id_input.text()' in content:
        issues.append({
            "åŠŸèƒ½": "å®æ—¶é¢„è§ˆ", 
            "é—®é¢˜": "é¢„è§ˆåªä½¿ç”¨device_id_inputï¼Œå¿½ç•¥è®¾å¤‡åˆ—è¡¨é€‰æ‹©",
            "å½±å“": "å¤šè®¾å¤‡æ—¶é¢„è§ˆé»‘å±æˆ–é”™è¯¯è®¾å¤‡",
            "ä¸¥é‡ç¨‹åº¦": "é«˜"
        })
        print("   âŒ é¢„è§ˆåªä½¿ç”¨device_id_input")
    else:
        print("   âœ… é¢„è§ˆä½¿ç”¨æ­£ç¡®çš„è®¾å¤‡ID")
    
    # 2. è®¾å¤‡è¿æ¥åŠŸèƒ½
    print("\nğŸ”Œ 2. è®¾å¤‡è¿æ¥åŠŸèƒ½")
    print("-" * 30)
    
    # æ£€æŸ¥è¿æ¥æ˜¯å¦æ”¯æŒå¤šè®¾å¤‡
    if 'self.device_list.selectedItems()' not in content:
        issues.append({
            "åŠŸèƒ½": "è®¾å¤‡è¿æ¥",
            "é—®é¢˜": "è¿æ¥åŠŸèƒ½æœªæ”¯æŒå¤šè®¾å¤‡é€‰æ‹©",
            "å½±å“": "æ— æ³•æ‰¹é‡è¿æ¥å¤šä¸ªè®¾å¤‡",
            "ä¸¥é‡ç¨‹åº¦": "ä¸­"
        })
        print("   âŒ è¿æ¥åŠŸèƒ½æœªæ”¯æŒå¤šè®¾å¤‡é€‰æ‹©")
    else:
        print("   âœ… è¿æ¥åŠŸèƒ½æ”¯æŒå¤šè®¾å¤‡é€‰æ‹©")
    
    # 3. ä»»åŠ¡æ‰§è¡ŒåŠŸèƒ½
    print("\nâš¡ 3. ä»»åŠ¡æ‰§è¡ŒåŠŸèƒ½")
    print("-" * 30)
    
    # æ£€æŸ¥ä»»åŠ¡æ‰§è¡Œæ˜¯å¦æ”¯æŒå¤šè®¾å¤‡
    if 'task_device_list.selectedItems()' in content:
        print("   âœ… ä»»åŠ¡æ‰§è¡Œæ”¯æŒå¤šè®¾å¤‡é€‰æ‹©")
    else:
        print("   âŒ ä»»åŠ¡æ‰§è¡Œæœªæ”¯æŒå¤šè®¾å¤‡é€‰æ‹©")
        issues.append({
            "åŠŸèƒ½": "ä»»åŠ¡æ‰§è¡Œ",
            "é—®é¢˜": "ä»»åŠ¡æ‰§è¡Œæœªæ”¯æŒå¤šè®¾å¤‡é€‰æ‹©",
            "å½±å“": "æ— æ³•æ‰¹é‡æ‰§è¡Œä»»åŠ¡",
            "ä¸¥é‡ç¨‹åº¦": "é«˜"
        })
    
    # 4. åº”ç”¨å®‰è£…åŠŸèƒ½
    print("\nğŸ“± 4. åº”ç”¨å®‰è£…åŠŸèƒ½")
    print("-" * 30)
    
    # æ£€æŸ¥APKå®‰è£…æ˜¯å¦æ”¯æŒå¤šè®¾å¤‡
    if 'device_list.selectedItems()' in content and 'apk_install' in content:
        print("   âœ… APKå®‰è£…å¯èƒ½æ”¯æŒå¤šè®¾å¤‡")
    else:
        print("   âŒ APKå®‰è£…æœªæ”¯æŒå¤šè®¾å¤‡é€‰æ‹©")
        issues.append({
            "åŠŸèƒ½": "åº”ç”¨å®‰è£…",
            "é—®é¢˜": "APKå®‰è£…æœªæ”¯æŒå¤šè®¾å¤‡é€‰æ‹©",
            "å½±å“": "æ— æ³•æ‰¹é‡å®‰è£…APK",
            "ä¸¥é‡ç¨‹åº¦": "ä¸­"
        })
    
    # 5. è„šæœ¬ç®¡ç†åŠŸèƒ½
    print("\nğŸ“œ 5. è„šæœ¬ç®¡ç†åŠŸèƒ½")
    print("-" * 30)
    
    # æ£€æŸ¥è„šæœ¬æ‰§è¡Œæ˜¯å¦æ”¯æŒå¤šè®¾å¤‡
    if 'script' in content.lower() and 'selectedItems()' in content:
        print("   âœ… è„šæœ¬ç®¡ç†å¯èƒ½æ”¯æŒå¤šè®¾å¤‡")
    else:
        print("   âŒ è„šæœ¬ç®¡ç†æœªæ”¯æŒå¤šè®¾å¤‡é€‰æ‹©")
        issues.append({
            "åŠŸèƒ½": "è„šæœ¬ç®¡ç†",
            "é—®é¢˜": "è„šæœ¬æ‰§è¡Œæœªæ”¯æŒå¤šè®¾å¤‡é€‰æ‹©",
            "å½±å“": "æ— æ³•æ‰¹é‡æ‰§è¡Œè„šæœ¬",
            "ä¸¥é‡ç¨‹åº¦": "ä¸­"
        })
    
    # 6. ç³»ç»Ÿè¯Šæ–­åŠŸèƒ½
    print("\nğŸ”§ 6. ç³»ç»Ÿè¯Šæ–­åŠŸèƒ½")
    print("-" * 30)
    
    # æ£€æŸ¥è¯Šæ–­æ˜¯å¦æ”¯æŒå¤šè®¾å¤‡
    if 'diagnostic' in content.lower() and 'selectedItems()' in content:
        print("   âœ… ç³»ç»Ÿè¯Šæ–­å¯èƒ½æ”¯æŒå¤šè®¾å¤‡")
    else:
        print("   âŒ ç³»ç»Ÿè¯Šæ–­æœªæ”¯æŒå¤šè®¾å¤‡é€‰æ‹©")
        issues.append({
            "åŠŸèƒ½": "ç³»ç»Ÿè¯Šæ–­",
            "é—®é¢˜": "ç³»ç»Ÿè¯Šæ–­æœªæ”¯æŒå¤šè®¾å¤‡é€‰æ‹©",
            "å½±å“": "æ— æ³•æ‰¹é‡è¯Šæ–­å¤šä¸ªè®¾å¤‡",
            "ä¸¥é‡ç¨‹åº¦": "ä½"
        })
    
    # 7. è®¾å¤‡çŠ¶æ€æ˜¾ç¤º
    print("\nğŸ“Š 7. è®¾å¤‡çŠ¶æ€æ˜¾ç¤º")
    print("-" * 30)
    
    # æ£€æŸ¥æ˜¯å¦æœ‰è®¾å¤‡çŠ¶æ€å®æ—¶æ›´æ–°
    if 'device_status' in content.lower() and 'timer' in content.lower():
        print("   âœ… å¯èƒ½æœ‰è®¾å¤‡çŠ¶æ€å®æ—¶æ›´æ–°")
    else:
        print("   âŒ ç¼ºå°‘è®¾å¤‡çŠ¶æ€å®æ—¶æ›´æ–°")
        issues.append({
            "åŠŸèƒ½": "è®¾å¤‡çŠ¶æ€",
            "é—®é¢˜": "ç¼ºå°‘è®¾å¤‡çŠ¶æ€å®æ—¶æ›´æ–°",
            "å½±å“": "æ— æ³•å®æ—¶ç›‘æ§å¤šè®¾å¤‡çŠ¶æ€",
            "ä¸¥é‡ç¨‹åº¦": "ä½"
        })
    
    # 8. é…ç½®ç®¡ç†
    print("\nâš™ï¸ 8. é…ç½®ç®¡ç†")
    print("-" * 30)
    
    # æ£€æŸ¥æ˜¯å¦æœ‰è®¾å¤‡ç‰¹å®šé…ç½®
    if 'device_config' in content.lower() or 'per_device' in content.lower():
        print("   âœ… å¯èƒ½æœ‰è®¾å¤‡ç‰¹å®šé…ç½®")
    else:
        print("   âŒ ç¼ºå°‘è®¾å¤‡ç‰¹å®šé…ç½®")
        issues.append({
            "åŠŸèƒ½": "é…ç½®ç®¡ç†",
            "é—®é¢˜": "ç¼ºå°‘è®¾å¤‡ç‰¹å®šé…ç½®",
            "å½±å“": "æ— æ³•ä¸ºä¸åŒè®¾å¤‡è®¾ç½®ä¸åŒé…ç½®",
            "ä¸¥é‡ç¨‹åº¦": "ä½"
        })
    
    return issues

def generate_fix_recommendations(issues):
    """ç”Ÿæˆä¿®å¤å»ºè®®"""
    print("\n" + "=" * 60)
    print("ğŸ› ï¸ ä¿®å¤å»ºè®®")
    print("=" * 60)
    
    # æŒ‰ä¸¥é‡ç¨‹åº¦åˆ†ç»„
    high_priority = [i for i in issues if i["ä¸¥é‡ç¨‹åº¦"] == "é«˜"]
    medium_priority = [i for i in issues if i["ä¸¥é‡ç¨‹åº¦"] == "ä¸­"]
    low_priority = [i for i in issues if i["ä¸¥é‡ç¨‹åº¦"] == "ä½"]
    
    if high_priority:
        print("\nğŸ”¥ é«˜ä¼˜å…ˆçº§ä¿®å¤:")
        for i, issue in enumerate(high_priority, 1):
            print(f"{i}. {issue['åŠŸèƒ½']}: {issue['é—®é¢˜']}")
            print(f"   å½±å“: {issue['å½±å“']}")
            if issue['åŠŸèƒ½'] == "å®æ—¶é¢„è§ˆ":
                print("   å»ºè®®: æ·»åŠ è®¾å¤‡åˆ—è¡¨ç‚¹å‡»äº‹ä»¶ï¼Œæ›´æ–°é¢„è§ˆä½¿ç”¨é€‰ä¸­çš„è®¾å¤‡ID")
            elif issue['åŠŸèƒ½'] == "ä»»åŠ¡æ‰§è¡Œ":
                print("   å»ºè®®: ç¡®ä¿ä»»åŠ¡æ‰§è¡Œæ”¯æŒå¤šè®¾å¤‡å¹¶è¡Œå¤„ç†")
    
    if medium_priority:
        print("\nâš ï¸ ä¸­ä¼˜å…ˆçº§ä¿®å¤:")
        for i, issue in enumerate(medium_priority, 1):
            print(f"{i}. {issue['åŠŸèƒ½']}: {issue['é—®é¢˜']}")
            print(f"   å½±å“: {issue['å½±å“']}")
            if issue['åŠŸèƒ½'] == "è®¾å¤‡è¿æ¥":
                print("   å»ºè®®: æ·»åŠ æ‰¹é‡è¿æ¥åŠŸèƒ½")
            elif issue['åŠŸèƒ½'] == "åº”ç”¨å®‰è£…":
                print("   å»ºè®®: æ·»åŠ å¤šè®¾å¤‡APKå®‰è£…é€‰é¡¹")
    
    if low_priority:
        print("\nğŸ’¡ ä½ä¼˜å…ˆçº§æ”¹è¿›:")
        for i, issue in enumerate(low_priority, 1):
            print(f"{i}. {issue['åŠŸèƒ½']}: {issue['é—®é¢˜']}")
            print(f"   å½±å“: {issue['å½±å“']}")

def main():
    """ä¸»å‡½æ•°"""
    issues = analyze_multi_device_compatibility()
    
    print(f"\nğŸ“Š é—®é¢˜ç»Ÿè®¡:")
    print(f"   æ€»é—®é¢˜æ•°: {len(issues)}")
    print(f"   é«˜ä¼˜å…ˆçº§: {len([i for i in issues if i['ä¸¥é‡ç¨‹åº¦'] == 'é«˜'])}")
    print(f"   ä¸­ä¼˜å…ˆçº§: {len([i for i in issues if i['ä¸¥é‡ç¨‹åº¦'] == 'ä¸­'])}")
    print(f"   ä½ä¼˜å…ˆçº§: {len([i for i in issues if i['ä¸¥é‡ç¨‹åº¦'] == 'ä½'])}")
    
    if issues:
        generate_fix_recommendations(issues)
        
        print("\nğŸ¯ ç«‹å³ä¿®å¤å»ºè®®:")
        print("1. ä¿®å¤å®æ—¶é¢„è§ˆåŠŸèƒ½ - è¿™æ˜¯æœ€å½±å“ç”¨æˆ·ä½“éªŒçš„é—®é¢˜")
        print("2. ç¡®ä¿ä»»åŠ¡æ‰§è¡Œæ”¯æŒå¤šè®¾å¤‡å¹¶è¡Œ")
        print("3. æ·»åŠ è®¾å¤‡åˆ—è¡¨é€‰æ‹©äº‹ä»¶å¤„ç†")
    else:
        print("\nğŸ‰ æœªå‘ç°å¤šè®¾å¤‡å…¼å®¹æ€§é—®é¢˜ï¼")

if __name__ == "__main__":
    main()
